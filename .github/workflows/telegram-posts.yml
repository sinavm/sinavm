name: Fetch Telegram Posts
on:
  schedule:
    - cron: '0 */2 * * *' # هر ۲ ساعت
  push: # برای تست دستی

jobs:
  fetch-posts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch Last 2 Posts from Telegram Channel
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          YOUR_BOT_TOKEN: ${{ secrets.YOUR_BOT_TOKEN }}
        run: |
          # دریافت دو پست آخر
          curl -s "https://api.telegram.org/bot${YOUR_BOT_TOKEN}/getUpdates?offset=-2" > posts.json

          # چاپ برای دیباگ
          echo "API Response:"
          cat posts.json

          # استخراج دو پست آخر و تبدیل به HTML
          jq '[.result[] | select(.message.chat.id == (env.TELEGRAM_CHAT_ID | tonumber)) | .message | {
            text: (.text // .caption // "بدون محتوا"),
            date: .date,
            link: "https://t.me/" + (.chat.username // "")
          }] | reverse | .[:2]' posts.json > posts_formatted.json

      - name: Update Telegram Posts HTML
        run: |
          echo '<div class="telegram-posts">' > telegram-posts.html

          jq -r '.[] | "<div class=\"telegram-post\">
            <a href=\"" + .link + "\" target=\"_blank\" class=\"post-link\">
              <div class=\"post-text\">" + .text + "</div>
              <small class=\"post-date\">" + (.date | todate) + "</small>
            </a>
          </div>"' posts_formatted.json >> telegram-posts.html

          echo '</div>' >> telegram-posts.html

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add telegram-posts.html
          git commit -m 'Update Telegram posts' || echo "No changes to commit"
          git push
